# Overview

The cdb-support repo provides tools for managing an ecosystem that includes the [Component Database (CDB)](https://github.com/AdvancedPhotonSource/ComponentDB) and [Traveler](https://github.com/AdvancedPhotonSource/traveler) applications developed at Argonne National Laboratory's [Advanced Photon Source](https://aps.anl.gov/) and Michigan State University's [Facility for Rare Isotope Beams](https://frib.msu.edu/), respectively.

I've installed these applications at several particle accelerator and other large-scale experimental/research facilities, and decided it would be useful to have a common approach and set of tools for administering such an ecosystem.  Currently, I'm deploying servers on AWS Lightsail that include these applications plus supporting services, including:

- Centos 8 stream Linux operating system
- MariaDB relational database service
- MongoDB noSQL datbase service
- shared TLS certificate to enable secure HTTPS protocol across all applications and administrative tools
- [OpenLDAP](https://github.com/osixia/docker-openldap) authentication service
- [phpLDAPadmin](https://github.com/osixia/docker-phpLDAPadmin) for managing LDAP service
- [NGINX](https://www.nginx.com/resources/glossary/nginx/) reverse proxy engine to provide uniform URL interface across all tools and applications and improve security by exposing a single external network port on the application server
- [Payara](https://www.payara.fish/) Java EE application server
- Component Database (CDB) application
- Traveler application
- CDB-Traveler integration via CDB plugin
- web portals for administration of LDAP and Payara services
- Mongo Express web portal providing GUI front-end to MongoDB

## project github repos

I created two github repos to support building these servers.  This repo, cdb-support, contains scripts and other tools intended to be used in all server deployments.  The other, [cdb-deployment](https://github.com/craigmcchesney/cdb-deployment), contains artifacts such as config files that vary between server deployments.

### cdb-support repo

This cdb-support repo contains the following directories:

- bin - Includes scripts for managing the various applications and services, including the cdb and traveler applciations, ldap, mongodb, and mysql. It has scripts for starting and stopping the entire ecosystem and utilities for managing the TLS certificate via "certbot".  I've also begun development of a Python customization tool for configuring a new application server instance.
- sql - Includes some common SQL for initializing a new CDB MySQL database, or manipulating an existing one.
- customization - Includes config file templates with substitution variables as input to the customization tool.
- env - Sets up the user's Linux environment for utilizing the two two repos.
- openldap - Provides docker compose configuration for OpenLDAP and phpLDAPadmin tools.

### cdb-deployment repo

The cdb-deployment repo contains the following directories:

- config
    - cdb - Config directory for cdb application, mounted by symbolic link to /opt/cdb/etc under the CDB installation.
    - traveler - Config directory for traveler application, mounted by symbolic link to /opt/traveler/etc under the Traveler installation.
    - nginx - Used to manage copy of the /etc/nginx/conf.d directory, unfortunately not a good way to manage this directly in github since systemctl blows up if symbolic links are used in the NGINX configuration.
- custom
    - config-edits - Symbolic links to the application configs edited for this deployment (precursor or possible input to customization tool).
    - cron - Crontab file for Linux user, includes reboot entry to start the application ecosystem etc.
    - env - Defines environment variables for the Linux user for use by scripts etc.
    - images - User can provide logo images to override CDB defaults.
    - sql - Custom sql files used to initialize or otherwise manipulate the CDB MySQL database.
- var (included in gitignore file so contents not managed)
    - logs
        - cdb-logs - Symbolic link to payara/glassfish logs for CDB.
        - pm2-logs - PM2 logs for traveler application.
        - logs generated by scripts such as ecosystem-start on reboot
    - letsencrypt - Working directory for certbot in managing TLS certificate.
- docker-volume-mounts - Provides OS directories mounted to docker containers.
    - openldap - Contains docker volume mounts for various openldap container directories needed for docker-compose configuration.

## using the repos

Currently, my primary approach for using these repos is in VM instances deployed on AWS Lightsail.  As you might imagine, the installation checklist for all of the applications and supporting services is quite large, so one of my primary objectives was to build a reference Lightsail VM that I can copy and customize to create new application server instances.  To that end, I have been mostly successful, with a process for deploying new instances that takes a couple of hours instead of a couple of days (or more).

Given this approach, I don't really have an "installation script" for building a new application server from scratch, though I will probably start to put one together the next time I'm asked to do so.  This is something I hope to avoid, however, as installing on a host at a new facility requires that I complete various IT and safety training programs, get to know system administrators, resolve issues due to differences in the host operating systems and other environments, deal with integration issues for LDAP authentication, work around Oracle-only database policies, etc etc etc.

I have started working on a customization script in Python, that uses configuration file templates with embedded substituion variables, reads environment variables to obtain custom values for those variables, and generates configuration files for the various applications and tools.  But this might also be overkill, depending on how many times I'll be asked to do this.  So for now, I have a concise checklist of steps for customizing a Lightsail VM for a new deployment.

### CDB/Traveler Lightsail VM customization checklist

